<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cadastro de Serviços</title>

  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <!-- Bootstrap Icons -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
  />
  <!-- Custom CSS -->
  <link rel="stylesheet" href="assets/css/lazuli.css" />
</head>
<body>
  <!-- Modal de Login -->
  <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="loginModalLabel">Login de Administrador</h5>
        </div>
        <div class="modal-body">
          <form id="loginForm">
            <div class="mb-3">
              <label for="username" class="form-label">Usuário</label>
              <input type="text" class="form-control" id="username" required />
            </div>
            <div class="mb-3">
              <label for="password" class="form-label">Senha</label>
              <input type="password" class="form-control" id="password" required />
            </div>
            <button type="submit" class="btn btn-primary w-100">Entrar</button>
          </form>
          <div id="loginError" class="text-danger mt-2" style="display:none;">Usuário ou senha inválidos!</div>
        </div>
      </div>
    </div>
  </div>

  <main class="container my-5" id="mainContent" style="display:none;">
    <div class="text-center mb-5">
      <h2 class="fw-bold">Cadastro de Serviços</h2>
      <p class="text-muted">Preencha o formulário abaixo para cadastrar um novo serviço.</p>
    </div>

    <form id="serviceForm" class="needs-validation" novalidate>
      <div class="mb-3">
        <label for="name" class="form-label">Nome</label> <!-- Alterado de "Nome do Serviço" para "Nome" -->
        <input type="text" class="form-control" id="name" name="name" required />
        <div class="invalid-feedback">Por favor, insira o nome.</div>
      </div>

      <div class="mb-3">
        <label for="category" class="form-label">Categoria</label>
        <input list="categories" class="form-control" id="category" name="category" required />
        <datalist id="categories">
          <!-- Categorias serão carregadas dinamicamente -->
        </datalist>
        <div class="invalid-feedback">Por favor, insira a categoria.</div>
      </div>

      <div class="mb-3">
        <label for="contact" class="form-label">Contato (WhatsApp)</label>
        <input type="text" class="form-control" id="contact" name="contact" required />
        <div class="invalid-feedback">Por favor, insira o número de contato.</div>
      </div>

      <div class="mb-3">
        <label for="tower" class="form-label">Torre</label>
        <input type="text" class="form-control" id="tower" name="tower" required />
        <div class="invalid-feedback">Por favor, insira a torre.</div>
      </div>

      <button type="submit" class="btn btn-primary">Cadastrar</button>
    </form>

    <div class="mt-5">
      <h3 class="fw-bold">Deletar Serviço</h3>
      <form id="deleteForm" class="needs-validation" novalidate>
        <div class="mb-3">
          <label for="serviceId" class="form-label">ID do Serviço</label>
          <input type="text" class="form-control" id="serviceId" name="serviceId" required />
          <div class="invalid-feedback">Por favor, insira o ID do serviço.</div>
        </div>
        <button type="submit" class="btn btn-danger">Deletar</button>
      </form>
    </div>

    <div class="mt-5">
      <h3 class="fw-bold">Serviços Cadastrados</h3>
      <ul id="serviceList" class="list-group">
        <!-- Serviços serão listados aqui -->
      </ul>
    </div>
  </main>

  <!-- Modal para editar serviço -->
  <div class="modal fade" id="editServiceModal" tabindex="-1" aria-labelledby="editServiceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editServiceModalLabel">Editar Serviço</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editServiceForm" class="needs-validation" novalidate>
            <input type="hidden" id="editServiceId" />
            <div class="mb-3">
              <label for="editName" class="form-label">Nome do Serviço</label>
              <input type="text" class="form-control" id="editName" required />
              <div class="invalid-feedback">Por favor, insira o nome do serviço.</div>
            </div>
            <div class="mb-3">
              <label for="editCategory" class="form-label">Categoria</label>
              <input type="text" class="form-control" id="editCategory" required />
              <div class="invalid-feedback">Por favor, insira a categoria.</div>
            </div>
            <div class="mb-3">
              <label for="editContact" class="form-label">Contato (WhatsApp)</label>
              <input type="text" class="form-control" id="editContact" required />
              <div class="invalid-feedback">Por favor, insira o número de contato.</div>
            </div>
            <div class="mb-3">
              <label for="editTower" class="form-label">Torre</label>
              <input type="text" class="form-control" id="editTower" required />
              <div class="invalid-feedback">Por favor, insira a torre.</div>
            </div>
            <button type="submit" class="btn btn-primary">Salvar Alterações</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
  ></script>

  <!-- Script for form submission -->
  <script>
    // Unificado: Login, fetch, cadastro, edição, exclusão
    document.addEventListener('DOMContentLoaded', () => {
      const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
      loginModal.show();
      document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const user = document.getElementById('username').value.trim();
        const pass = document.getElementById('password').value;
        if (user === 'admin' && pass === 'admin123') {
          loginModal.hide();
          document.getElementById('mainContent').style.display = 'block';
          fetchCategories();
          fetchServices();
        } else {
          document.getElementById('loginError').style.display = 'block';
        }
      });

      // Busca categorias únicas do backend
      async function fetchCategories() {
        try {
          const response = await fetch('https://backend-rust-phi-51.vercel.app/api/services');
          if (response.ok) {
            const services = await response.json();
            // Remove duplicadas (case-insensitive, ignora espaços)
            const categoriesSet = new Set();
            services.forEach(service => {
              if (service.category) {
                categoriesSet.add(service.category.trim().toLowerCase());
              }
            });
            window.existingCategories = Array.from(categoriesSet);
            const datalist = document.getElementById('categories');
            datalist.innerHTML = Array.from(categoriesSet).map(category => `<option value="${category}"></option>`).join('');
          } else {
            console.error('Erro ao buscar categorias.');
          }
        } catch (error) {
          console.error('Erro ao buscar categorias:', error);
        }
      }

      // Carregar serviços
      async function fetchServices() {
        try {
          const response = await fetch('https://backend-rust-phi-51.vercel.app/api/services');
          if (response.ok) {
            const services = await response.json();
            const serviceList = document.getElementById('serviceList');
            serviceList.innerHTML = '';
            services.forEach(service => {
              const listItem = document.createElement('li');
              listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
              listItem.innerHTML = `
                <span>
                  <strong>${service.name}</strong> - ${service.category} - ${service.contact} - ${service.tower}
                </span>
                <div>
                  <button class="btn btn-warning btn-sm me-2" onclick="editService('${service._id}')">Editar</button>
                  <button class="btn btn-danger btn-sm" onclick="deleteService('${service._id}')">Deletar</button>
                </div>
              `;
              serviceList.appendChild(listItem);
            });
          } else {
            alert('Erro ao buscar serviços.');
          }
        } catch (error) {
          console.error('Erro ao buscar serviços:', error);
          alert('Erro ao buscar serviços. Tente novamente mais tarde.');
        }
      }

      // Cadastro de serviço
      document.getElementById('serviceForm').addEventListener('submit', async function (event) {
        event.preventDefault();
        if (!this.checkValidity()) {
          this.classList.add('was-validated');
          return;
        }

        const name = document.getElementById('name').value;
        const category = document.getElementById('category').value;
        const contact = document.getElementById('contact').value;
        const tower = document.getElementById('tower').value;

        // Validação de categoria duplicada (case-insensitive, ignora espaços)
        if (window.existingCategories && window.existingCategories.includes(category.trim().toLowerCase())) {
          alert('Esta categoria já existe! Por favor, selecione-a da lista ou escolha outro nome.');
          return;
        }

        const formData = { name, category, contact, tower };

        try {
          const response = await fetch('https://backend-rust-phi-51.vercel.app/api/services', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData),
          });

          if (response.ok) {
            alert('Serviço cadastrado com sucesso!');
            this.reset();
            this.classList.remove('was-validated');
            fetchCategories();
            fetchServices();
          } else {
            const errorData = await response.json();
            alert(`Erro ao cadastrar serviço: ${errorData.error}`);
          }
        } catch (error) {
          console.error('Erro ao enviar o formulário:', error);
          alert('Erro ao cadastrar serviço. Tente novamente mais tarde.');
        }
      });

      // Deletar serviço
      document.getElementById('deleteForm').addEventListener('submit', async function (event) {
        event.preventDefault();
        if (!this.checkValidity()) {
          this.classList.add('was-validated');
          return;
        }

        const serviceId = document.getElementById('serviceId').value;

        if (!confirm("Tem certeza que deseja deletar este serviço?")) return;

        try {
          const response = await fetch(`https://backend-rust-phi-51.vercel.app/api/services/${serviceId}`, {
            method: 'DELETE',
          });

          if (response.ok) {
            alert('Serviço deletado com sucesso!');
            this.reset();
            this.classList.remove('was-validated');
            fetchCategories();
            fetchServices();
          } else {
            const errorData = await response.json();
            alert(`Erro ao deletar serviço: ${errorData.error}`);
          }
        } catch (error) {
          console.error('Erro ao deletar o serviço:', error);
          alert('Erro ao deletar serviço. Tente novamente mais tarde.');
        }
      });

      // Editar serviço
      window.editService = function(serviceId) {
        fetch(`https://backend-rust-phi-51.vercel.app/api/services/${serviceId}`)
          .then(response => response.json())
          .then(service => {
            document.getElementById('editServiceId').value = serviceId;
            document.getElementById('editName').value = service.name;
            document.getElementById('editCategory').value = service.category;
            document.getElementById('editContact').value = service.contact;
            document.getElementById('editTower').value = service.tower;
            const editModal = new bootstrap.Modal(document.getElementById('editServiceModal'));
            editModal.show();
          })
          .catch(error => {
            console.error('Erro ao buscar serviço para edição:', error);
            alert('Erro ao buscar serviço. Tente novamente mais tarde.');
          });
      }

      document.getElementById('editServiceForm').addEventListener('submit', async function (event) {
        event.preventDefault();
        if (!this.checkValidity()) {
          this.classList.add('was-validated');
          return;
        }

        const serviceId = document.getElementById('editServiceId').value;
        const updatedData = {
          name: document.getElementById('editName').value,
          category: document.getElementById('editCategory').value,
          contact: document.getElementById('editContact').value,
          tower: document.getElementById('editTower').value,
        };

        try {
          const response = await fetch(`https://backend-rust-phi-51.vercel.app/api/services/${serviceId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updatedData),
          });

          if (response.ok) {
            alert('Serviço atualizado com sucesso!');
            const editModal = bootstrap.Modal.getInstance(document.getElementById('editServiceModal'));
            editModal.hide();
            fetchCategories();
            fetchServices();
          } else {
            const errorData = await response.json();
            alert(`Erro ao atualizar serviço: ${errorData.error}`);
          }
        } catch (error) {
          console.error('Erro ao atualizar o serviço:', error);
          alert('Erro ao atualizar serviço. Tente novamente mais tarde.');
        }
      });
    });
  </script>
</body>
</html>
